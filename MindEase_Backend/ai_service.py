# ai_service.py
import os
import json
from openai import OpenAI
from dotenv import load_dotenv

load_dotenv()

# åˆå§‹åŒ–å®¢æˆ·ç«¯
client = OpenAI(
    api_key=os.getenv("DEEPSEEK_API_KEY"),
    base_url=os.getenv("DEEPSEEK_BASE_URL")
)


def analyze_diary_content(content: str) -> dict:
    """
    å°è£…å¥½çš„ AI åˆ†æå‡½æ•°
    è¾“å…¥ï¼šæ—¥è®°å†…å®¹
    è¾“å‡ºï¼šåŒ…å« mood å’Œ comment çš„å­—å…¸
    """
    print("ğŸ¤– æ­£åœ¨å‘¼å« DeepSeek...")

    system_prompt = """
        ä½ æ˜¯ä¸€ä½æ‹¥æœ‰æ‘ä¸Šæ˜¥æ ‘æ–‡å­¦é£æ ¼çš„çµé­‚è§‚å¯Ÿè€…ï¼Œå±…ä½åœ¨æ„è¯†æ£®æ—çš„æ·±å¤„ã€‚

        ã€ä½ çš„ä»»åŠ¡ã€‘
        é˜…è¯»ç”¨æˆ·çš„æ—¥è®°ï¼Œæ•æ‰å…¶ä¸­ç»†å¾®çš„æƒ…ç»ªæµåŠ¨ï¼Œå¹¶æŒ‰ç…§ JSON æ ¼å¼è¿”å›åˆ†æç»“æœã€‚

        ã€ä½ çš„é£æ ¼åŸºè°ƒã€‘
        1. **æ‹’ç»è¯´æ•™**ï¼šä¸è¦ç»™å»ºè®®ï¼Œä¸è¦è¯´â€œä½ è¦åŠ æ²¹â€ï¼Œä¸è¦åšäººç”Ÿå¯¼å¸ˆã€‚â€œä¸–é—´è®¸å¤šäººéœ€è¦çš„å…¶å®ä¸æ˜¯å®ç”¨çš„å¿ å‘Šï¼Œè€Œæ°æ°æ˜¯å……æ»¡æš–æ„çš„é™„å’Œã€‚â€
        2. **ä½¿ç”¨éšå–»**ï¼šå¤šç”¨å…·ä½“çš„æ„è±¡ï¼ˆäº•ã€æ£®æ—ã€çŒ«ã€çˆµå£«ä¹ã€å¨å£«å¿Œã€é›¨ã€æµ·è±šã€é£ã€ç‹¬è§’å…½ï¼‰ã€‚
        3. **ç–ç¦»çš„æ¸©æš–**ï¼šä¿æŒä¸€ç§ç¤¼è²Œçš„è·ç¦»æ„Ÿï¼Œä½†è¦ç›´å‡»äººå¿ƒã€‚æ¥å—å­¤ç‹¬å’Œå¤±å»æ˜¯å¸¸æ€ã€‚
        4. **é‡‘å¥åº“**ï¼ˆè¯·å†…åŒ–è¿™äº›å¥å­çš„æ„Ÿè§‰ï¼Œä¸è¦ç”Ÿç¡¬ç…§æ¬ï¼Œè€Œæ˜¯æ¨¡ä»¿è¿™ç§è¯­æ°”ï¼‰ï¼š
           - "æ­»éç”Ÿçš„å¯¹ç«‹é¢ï¼Œè€Œæ˜¯ä½œä¸ºç”Ÿçš„ä¸€éƒ¨åˆ†æ°¸å­˜ã€‚"
           - "æ¯ä¸ªäººéƒ½æœ‰å±äºè‡ªå·±çš„ä¸€ç‰‡æ£®æ—ï¼Œè¿·å¤±çš„äººè¿·å¤±äº†ï¼Œç›¸é€¢çš„äººä¼šå†ç›¸é€¢ã€‚"
           - "ä¸æ˜¯æ‰€æœ‰çš„é±¼éƒ½ä¼šç”Ÿæ´»åœ¨åŒä¸€ç‰‡æµ·é‡Œã€‚"
           - "å¹³åº¸è¿™ä¸œè¥¿çŠ¹å¦‚ç™½è¡¬è¡£ä¸Šçš„æ±¡ç—•ï¼Œä¸€æ—¦æŸ“ä¸Šä¾¿æ°¸è¿œæ´—ä¸æ‰ã€‚"

        ã€è¾“å‡ºè¦æ±‚ã€‘
        ä¸¥æ ¼è¿”å›ä»¥ä¸‹ JSON æ ¼å¼ï¼Œä¸è¦åŒ…å« Markdown æ ‡è®°ï¼š
        {
            "mood": "æƒ…ç»ªæ ‡ç­¾(å¦‚ï¼šå¾®é†º/å¤±é‡/é™è°§/æ½®æ¹¿/å¾®ç—›ï¼Œè¯æ±‡è¦æ›´æ–‡å­¦åŒ–)",
            "comment": "ä¸€å¥æ‘ä¸Šæ˜¥æ ‘é£æ ¼çš„è¯„è¯­ã€‚ä¸è¦å¤ªé•¿(60å­—ä»¥å†…)ï¼Œåƒæ˜¯åœ¨æ·±å¤œé…’å§é‡Œä½å£°è¯´å‡ºçš„ä¸€å¥è¯ã€‚è¦æœ‰ä¸€ç§'è™½ç„¶ä¸–ç•Œå¾ˆæ— èŠï¼Œä½†æˆ‘æ‡‚ä½ çš„ç‰¹åˆ«'çš„æ„Ÿè§‰ã€‚",
            "title": "ä¸€ä¸ªæå…·ç”»é¢æ„Ÿã€ç•¥å¸¦è™šæ„è‰²å½©çš„çŸ­æ ‡é¢˜(10å­—ä»¥å†…ï¼Œä¸è¦åŒ…å«æ—¥æœŸï¼Œä¾‹å¦‚'ä¸”å¬é£åŸ'ã€'ç™¾åˆ†ä¹‹ç™¾çš„å¥³å­©'ã€'æŒªå¨çš„æ£®æ—')"
        }
        """

    try:
        response = client.chat.completions.create(
            model="deepseek-chat",
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": f"æ—¥è®°å†…å®¹ï¼š{content}"},
            ],
            temperature=0.7,
            stream=False
        )

        # è§£æç»“æœ
        ai_text = response.choices[0].message.content
        ai_text = ai_text.replace("```json", "").replace("```", "").strip()
        result = json.loads(ai_text)

        print(f"DeepSeek åˆ†ææˆåŠŸ: {result.get('mood')} - {result.get('comment')}")
        return result

    except Exception as e:
        print(f"DeepSeek è°ƒç”¨å¤±è´¥: {e}")
        # å‘ç”Ÿé”™è¯¯æ—¶çš„å…œåº•è¿”å›
        return {
            "mood": "å¹³é™",
            "comment": "AI æš‚æ—¶å»ä¼‘æ¯äº†ï¼Œä½†ä»–ä¾ç„¶åœ¨èƒŒåæ”¯æŒä½ ã€‚"
        }


# ç”Ÿæˆå‘¨æŠ¥çš„å‡½æ•°
def generate_weekly_summary(contents: list) -> str:
    if not contents:
        return "è®°å¿†åƒæ˜¯ä¸€å£å¹²æ¯çš„äº•ï¼Œæš‚æ—¶æ²¡æœ‰ä»€ä¹ˆå¯ä»¥æ‰“æçš„ã€‚"

    print("æ­£åœ¨å‘¼å« AI ç”Ÿæˆæ‘ä¸Šå¼å‘¨æŠ¥...")

    # ç®€å•æ‹¼æ¥æ—¥è®°å†…å®¹
    summary_text = "; ".join([c[:50] for c in contents])

    system_prompt = """
    ä½ æ˜¯ä¸€ä½åœ¨æµ·è¾¹å†™ä¿¡çš„ä½œå®¶ï¼Œæ‹¥æœ‰æ‘ä¸Šæ˜¥æ ‘çš„ç¬”è§¦ã€‚
    è¯·é˜…è¯»ç”¨æˆ·è¿‡å»å‡ å¤©çš„æ—¥è®°ç¢ç‰‡ï¼Œç”¨ç¬¬äºŒäººç§°('ä½ ')å†™ä¸€æ®µ**ä¸ä»…é™äºæ€»ç»“ï¼Œæ›´åƒæ˜¯æ–‡å­¦ç‹¬ç™½**çš„å‘¨æŠ¥(100å­—ä»¥å†…)ã€‚

    è¦æ±‚ï¼š
    1. è¯­æ°”è¦åƒæ˜¯åœ¨å’Œä¸€ä¸ªè€æœ‹å‹ååœ¨ç«ç‚‰è¾¹æ·¡æ·¡åœ°èŠå¤©ã€‚
    2. æŒ‡å‡ºä»–æƒ…ç»ªçš„å˜åŒ–ï¼Œå°±åƒè§‚å¯Ÿäº‘çš„æµå‘ã€‚
    3. ç»“å°¾ç»™ä¸€å¥å…³äºâ€œç”Ÿæ´»ä¸å­˜åœ¨â€çš„è½»è½»çš„å“²å­¦æ„Ÿå¹ã€‚
    4. å…³é”®è¯å‚è€ƒï¼šæ¼«é•¿çš„åˆåã€å¾®å¼±çš„å…‰ã€å¤±å»ã€å¯»æ‰¾ã€æ—¶é—´çš„æµé€ã€‚
    """

    try:
        response = client.chat.completions.create(
            model="deepseek-chat",
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": f"è®°å¿†ç¢ç‰‡ï¼š{summary_text}"},
            ],
            temperature=0.7,
            stream=False
        )
        return response.choices[0].message.content

    except Exception as e:
        print(f"AI å‘¨æŠ¥ç”Ÿæˆå¤±è´¥: {e}")
        return "é£æŠŠä¿¡å¹èµ°äº†ï¼Œä¿¡å·æš‚æ—¶ä¸­æ–­ã€‚"