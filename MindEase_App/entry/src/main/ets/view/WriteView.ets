import { apiService } from '../services/ApiService';
import { Diary } from '../model/DiaryModel';
import promptAction from '@ohos.promptAction';

// --- 1. å®šä¹‰å¿ƒæƒ…æ•°æ®å¸¸é‡ ---
interface MoodOption {
  icon: string;
  score: number;
  label: string;
  color: string; // é€‰ä¸­æ—¶çš„èƒŒæ™¯è‰²
}

const MOOD_OPTIONS: MoodOption[] = [
  { icon: 'ðŸ˜«', score: 1, label: 'ç³Ÿç³•', color: '#FFEBEE' }, // çº¢
  { icon: 'ðŸ˜”', score: 2, label: 'ä½Žè½', color: '#F3E5F5' }, // ç´«
  { icon: 'ðŸ˜', score: 3, label: 'å¹³é™', color: '#E3F2FD' }, // è“
  { icon: 'ðŸ™‚', score: 4, label: 'å¼€å¿ƒ', color: '#E8F5E9' }, // ç»¿
  { icon: 'ðŸ¤©', score: 5, label: 'æžå¥½', color: '#FFFDE7' }, // é»„
];

// --- 2. èŽ·å–å½“å‰æ ¼å¼åŒ–æ—¶é—´çš„å·¥å…·å‡½æ•° ---
function getFormattedDate(): string {
  const now = new Date();
  const year = now.getFullYear();
  const month = now.getMonth() + 1;
  const date = now.getDate();
  const weekDays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
  const day = weekDays[now.getDay()];
  return `${year}å¹´${month}æœˆ${date}æ—¥ ${day}`;
}


@Component
export struct WriteView {
  @State inputText: string = '';
  @State aiResult: string = '';
  @State isLoading: boolean = false;
  // å½“å‰é€‰ä¸­çš„å¿ƒæƒ…ç´¢å¼• (é»˜è®¤é€‰ä¸­ä¸­é—´çš„â€œå¹³é™â€)
  @State selectedMoodIndex: number = 2;
  // é¡µé¢åŠ è½½æ—¶çš„æ—¶é—´
  @State todayDateStr: string = getFormattedDate();

  build() {
    // ä½¿ç”¨ StackåšèƒŒæ™¯å±‚å 
    Stack({ alignContent: Alignment.Top }) {
      // èƒŒæ™¯è‰²
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('#F7F8FA') // é«˜çº§ç°èƒŒæ™¯

      // ä¸»ä½“å†…å®¹åŒºåŸŸ (å¯æ»šåŠ¨ï¼Œé˜²æ­¢å†…å®¹è¿‡å¤šé¡¶å‡ºåŽ»)
      Scroll() {
        Column() {
          // --- é¡¶éƒ¨ Header åŒºåŸŸ (æ—¶é—´å’Œå¿ƒæƒ…) ---
          Row() {
            // å·¦ä¾§ï¼šè‡ªåŠ¨æ—¶é—´æˆ³
            Column() {
              Text(this.todayDateStr.split(' ')[0]) // æ—¥æœŸ
                .fontSize(18)
                .fontWeight(FontWeight.Bold)
                .fontColor('#333')
              Text(this.todayDateStr.split(' ')[1]) // æ˜ŸæœŸ
                .fontSize(14)
                .fontColor('#999')
                .margin({ top: 4 })
            }
            .alignItems(HorizontalAlign.Start)

            // å³ä¾§ï¼šå¿ƒæƒ…é€‰æ‹©å™¨ (æ›¿ä»£åŽŸæ¥çš„æ»‘å—)
            Row({ space: 8 }) {
              ForEach(MOOD_OPTIONS, (item: MoodOption, index: number) => {
                // å¿ƒæƒ…å›¾æ ‡æŒ‰é’®
                Column() {
                  Text(item.icon).fontSize(24)
                }
                .width(44)
                .height(44)
                .justifyContent(FlexAlign.Center)
                .borderRadius(22) // åœ†å½¢
                // é€‰ä¸­çŠ¶æ€æ ·å¼åˆ‡æ¢
                .backgroundColor(this.selectedMoodIndex === index ? item.color : '#FFFFFF')
                .border({
                  width: this.selectedMoodIndex === index ? 2 : 0,
                  color: '#007DFF'
                })
                .shadow(this.selectedMoodIndex === index ? { radius: 8, color: 'rgba(0,125,255,0.2)' } : { radius: 0 })
                .animation({ duration: 200 }) // æ·»åŠ ç‚¹å‡»åŠ¨ç”»
                .onClick(() => {
                  this.selectedMoodIndex = index;
                })
              })
            }
            .backgroundColor('#FFFFFF')
            .padding(6)
            .borderRadius(30)
            .shadow({ radius: 10, color: 'rgba(0,0,0,0.05)' })

          }
          .width('90%')
          .justifyContent(FlexAlign.SpaceBetween)
          .margin({ top: 20, bottom: 20 })

          // --- æ ¸å¿ƒç¼–è¾‘å¡ç‰‡ ---
          Column() {
            // æ¨¡æ‹Ÿæ ‡é¢˜æ  (è™½ç„¶ä¸å­˜æ•°æ®åº“ï¼Œä½†åœ¨UIä¸Šæ˜¾ç¤º)
            Text('ä»Šæ—¥éšç¬”')
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .fontColor('#999')
              .width('100%')
              .padding({ left: 15, top: 15 })

            Divider().color('#F0F0F0').margin({ top: 10, bottom: 5 })

            // ä¼˜åŒ–åŽçš„æ–‡æœ¬è¾“å…¥åŒºåŸŸ
            TextArea({ placeholder: 'åœ¨è¿™é‡Œè®°å½•æ­¤åˆ»çš„æƒ³æ³•ï¼Œæ”¯æŒåˆ†æ®µæŽ’ç‰ˆ...' })
              .height(250) // æ›´é«˜çš„é«˜åº¦
              .width('100%')
              .backgroundColor(Color.Transparent) // é€æ˜ŽèƒŒæ™¯ï¼Œèžå…¥å¡ç‰‡
              .fontSize(17) // æ›´å¤§çš„å­—å·ï¼Œä¾¿äºŽé˜…è¯»
              .fontColor('#333')
              .padding(15)
              // ç§»é™¤é»˜è®¤çš„è¾“å…¥æ¡†è¾¹æ¡†çº¿ï¼Œçœ‹èµ·æ¥æ›´åƒä¸€å¼ çº¸
              .borderWidth(0)
              .onChange((value: string) => {
                this.inputText = value;
              })
          }
          .width('90%')
          .backgroundColor('#FFFFFF')
          .borderRadius(16)
          // æ·»åŠ æŸ”å’Œçš„é˜´å½±ï¼Œè¥é€ æ‚¬æµ®æ„Ÿ
          .shadow({ radius: 15, color: 'rgba(0,0,0,0.08)', offsetY: 5 })
          .margin({ bottom: 30 })


          // --- æäº¤æŒ‰é’® ---
          Button(this.isLoading ? 'âœ¨ AI æ­£åœ¨ç”¨å¿ƒæ€è€ƒ...' : 'ç”Ÿæˆ AI æ²»æ„ˆå›žä¿¡')
            .width('90%')
            .height(56) // æ›´é«˜å¤§ä¸Šçš„æŒ‰é’®é«˜åº¦
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .backgroundColor(this.isLoading ? '#E0E0E0' : '#007DFF')
            .enabled(!this.isLoading)
            // æ¸å˜è‰²é˜´å½±
            .shadow({ radius: 10, color: this.isLoading ? 'transparent' : 'rgba(0,125,255,0.4)', offsetY: 4 })
            .onClick(async () => {
              await this.submitDiary();
            })
            .animation({ duration: 200 }) // æŒ‰é’®çŠ¶æ€åˆ‡æ¢åŠ¨ç”»

          // --- AI ç»“æžœå±•ç¤ºå¡ç‰‡ (ä¼˜åŒ–ç‰ˆ) ---
          if (this.aiResult) {
            Column() {
              Row() {
                Image($r('app.media.app_icon')) // è¿™é‡Œå¯ä»¥ç”¨ä½ è‡ªå·±çš„AIå›¾æ ‡ï¼Œæ²¡æœ‰å°±ç”¨æ–‡å­—
                  .width(24).height(24).margin({right: 8})
                Text('AI å¿ƒç†å’¨è¯¢å¸ˆçš„å›žä¿¡')
                  .fontWeight(FontWeight.Bold)
                  .fontSize(16)
                  .fontColor('#007DFF')
              }
              .width('100%')
              .margin({ bottom: 15 })
              .alignItems(VerticalAlign.Center)

              // ä½¿ç”¨ Textç»„ä»¶æ˜¾ç¤ºå›žå¤ï¼Œè®¾ç½®è¡Œé«˜å’Œå­—é—´è·æå‡é˜…è¯»ä½“éªŒ
              Text(this.aiResult)
                .fontSize(16)
                .lineHeight(28) // æ›´å®½æ¾çš„è¡Œé«˜
                .letterSpacing(0.5)
                .fontColor('#444')
            }
            .width('90%')
            // ä½¿ç”¨æ¸å˜èƒŒæ™¯è‰²
            .linearGradient({
              angle: 180,
              colors: [['#F0F8FF', 0.0], ['#E6F2FF', 1.0]]
            })
            .borderRadius(16)
            .padding(20)
            .margin({ top: 30, bottom: 50 }) // åº•éƒ¨ç•™ç™½
            .shadow({ radius: 10, color: 'rgba(0,125,255,0.15)', offsetY: 5 })
            // ç»“æžœå‡ºçŽ°æ—¶çš„åŠ¨ç”»
            .transition({ type: TransitionType.Insert, opacity: 0, translate: { y: 30 } })
          }

        }
        .width('100%')
      }
      .scrollBar(BarState.Off) // éšè—æ»šåŠ¨æ¡
      .align(Alignment.Top)
      .height('100%')
    }
    .width('100%')
    .height('100%')
  }

  async submitDiary() {
    if (this.inputText.trim() === '') {
      promptAction.showToast({ message: 'å†™ç‚¹ä»€ä¹ˆå§ï¼Œç©ºçš„æ—¥è®°æ— æ³•åˆ†æžå“¦~' });
      return;
    }
    this.isLoading = true;
    this.aiResult = '';
    try {
      // èŽ·å–å½“å‰é€‰ä¸­çš„å¿ƒæƒ…åˆ†æ•°
      const currentScore = MOOD_OPTIONS[this.selectedMoodIndex].score;

      const result = await apiService.createDiary(this.inputText, currentScore);

      if (result && result.ai_comment) {
        // ä½¿ç”¨åŠ¨ç”»è®©ç»“æžœå¹³æ»‘æ˜¾ç¤º
        animateTo({ duration: 600, curve: Curve.FastOutSlowIn }, () => {
          this.aiResult = result.ai_comment || '';
        })
        promptAction.showToast({ message: 'åˆ†æžæˆåŠŸï¼' });
        // å¯é€‰ï¼šå‘é€æˆåŠŸåŽæ¸…ç©ºè¾“å…¥æ¡†
        // this.inputText = '';
      } else {
        promptAction.showToast({ message: 'è¯·æ±‚æˆåŠŸï¼Œä½† AI æœªå›žå¤' });
      }
    } catch (err) {
      promptAction.showToast({ message: 'ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿žæŽ¥' });
    } finally {
      animateTo({ duration: 300 }, () => {
        this.isLoading = false;
      })
    }
  }
}