import { apiService } from '../services/ApiService';
import { Diary } from '../model/DiaryModel';
import promptAction from '@ohos.promptAction';

@Component
export struct WriteView {
  @State inputText: string = '';
  @State aiResult: string = '';
  @State isLoading: boolean = false;
  @State moodScore: number = 3;

  build() {
    Column() {
      // æ ‡é¢˜
      Text('MindEase æ™ºèƒ½å¿ƒè¯­')
        .fontSize(28)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333333')
        .margin({ top: 40, bottom: 20 })

      // è¾“å…¥æ¡†
      TextArea({ placeholder: 'åœ¨æ­¤å†™ä¸‹ä»Šå¤©å‘ç”Ÿçš„æ•…äº‹ï¼ŒDeepSeek ä¼šå€¾å¬ä½ çš„å¿ƒå£°...' })
        .height(180)
        .width('90%')
        .backgroundColor('#F5F5F5')
        .borderRadius(12)
        .fontSize(16)
        .padding(15)
        .onChange((value: string) => {
          this.inputText = value;
        })
        .margin({ bottom: 20 })

      // å¿ƒæƒ…æ»‘å—
      Row() {
        Text(`ä»Šæ—¥å¿ƒæƒ…æŒ‡æ•°: ${this.moodScore}åˆ†`).fontSize(14).fontColor('#666')
      }
      .width('90%')
      .justifyContent(FlexAlign.Start)
      .margin({ bottom: 5 })

      Row() {
        Text('â˜¹ï¸').fontSize(20)
        Slider({
          value: this.moodScore,
          min: 1,
          max: 5,
          step: 1,
          style: SliderStyle.OutSet
        })
          .width('70%')
          .blockColor('#007DFF')
          .onChange((value: number) => {
            this.moodScore = value;
          })
        Text('ğŸ˜„').fontSize(20)
      }
      .width('90%')
      .justifyContent(FlexAlign.SpaceBetween)
      .margin({ bottom: 30 })

      // æŒ‰é’®
      Button(this.isLoading ? 'âœ¨ AI æ­£åœ¨æ€è€ƒä¸­...' : 'ç”Ÿæˆ AI æ²»æ„ˆå›ä¿¡')
        .width('90%')
        .height(50)
        .fontSize(18)
        .backgroundColor(this.isLoading ? '#CCCCCC' : '#007DFF')
        .enabled(!this.isLoading)
        .shadow({ radius: 5, color: '#A0000000', offsetY: 5 })
        .onClick(async () => {
          await this.submitDiary();
        })

      // ç»“æœå¡ç‰‡
      if (this.aiResult) {
        Column() {
          Row() {
            Text('ğŸ¤– AI å¿ƒç†å’¨è¯¢å¸ˆ')
              .fontWeight(FontWeight.Bold)
              .fontSize(16)
              .fontColor('#007DFF')
          }
          .width('100%')
          .margin({ bottom: 10 })

          Text(this.aiResult)
            .fontSize(16)
            .lineHeight(26)
            .fontColor('#333333')
        }
        .width('90%')
        .backgroundColor('#E6F2FF')
        .borderRadius(12)
        .padding(20)
        .margin({ top: 30 })
        .shadow({ radius: 10, color: '#20000000', offsetY: 5 })
      }
    }
    .width('100%')
    .height('100%')
  }

  async submitDiary() {
    if (this.inputText.trim() === '') {
      promptAction.showToast({ message: 'å†™ç‚¹ä»€ä¹ˆå§~' });
      return;
    }
    this.isLoading = true;
    this.aiResult = '';
    try {
      const result = await apiService.createDiary(this.inputText, this.moodScore);
      if (result && result.ai_comment) {
        this.aiResult = result.ai_comment;
        promptAction.showToast({ message: 'åˆ†ææˆåŠŸï¼' });
      } else {
        promptAction.showToast({ message: 'è¯·æ±‚æˆåŠŸï¼Œä½† AI æœªå›å¤' });
      }
    } catch (err) {
      promptAction.showToast({ message: 'ç½‘ç»œé”™è¯¯' });
    } finally {
      this.isLoading = false;
    }
  }
}