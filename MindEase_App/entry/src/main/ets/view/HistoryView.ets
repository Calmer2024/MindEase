import { apiService } from '../services/ApiService';
import { Diary } from '../model/DiaryModel';

@Component
export struct HistoryView {
  @Prop @Watch('onTriggerChange') refreshTrigger: number = 0;
  @State diaryList: Diary[] = [];
  @State isLoading: boolean = false;

  async aboutToAppear() {
    this.fetchData();
  }

  onTriggerChange() {
    this.fetchData();
  }

  async fetchData() {
    // âš ï¸ æ³¨æ„ï¼šè¿™é‡Œä¸è¦å…ˆæ¸…ç©º listï¼Œå¦åˆ™é¡µé¢è¿˜æ˜¯ä¼šç™½ä¸€ä¸‹
    // this.diaryList = []; <--- åˆ æ‰è¿™è¡Œ

    this.isLoading = true;

    // æ¨¡æ‹Ÿä¸€ä¸ªå°å»¶è¿Ÿï¼Œä¸ç„¶æœ¬åœ°æ•°æ®å¤ªå¿«äº†çœ‹ä¸å‡ºåŠ è½½åœˆæ•ˆæœ(å¯é€‰)
    // await new Promise(resolve => setTimeout(resolve, 300));

    const result = await apiService.getDiaries();

    // âœ¨ æ ¸å¿ƒé­”æ³•ï¼šä½¿ç”¨ animateTo è®©æ•°æ®å˜åŒ–å¸¦åŠ¨ç”» âœ¨
    animateTo({ duration: 500, curve: Curve.FastOutSlowIn }, () => {
      this.diaryList = result;
      this.isLoading = false;
    })
  }

  build() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜
      Text('æ—¶å…‰æ¡£æ¡ˆ')
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .margin({ top: 40, bottom: 20 })
        .width('90%')

      // âœ¨ ä½¿ç”¨ Stack å †å å¸ƒå±€ âœ¨
      // åˆ—è¡¨åœ¨ä¸‹ï¼ŒåŠ è½½åœˆåœ¨ä¸Šã€‚åˆ—è¡¨æ°¸è¿œå­˜åœ¨ï¼Œä¸ä¼šæ¶ˆå¤±ï¼Œæ‰€ä»¥ä¸ä¼šå¡é¡¿ã€‚
      Stack({ alignContent: Alignment.Top }) {

        // --- å±‚çº§ 1: åˆ—è¡¨å†…å®¹ ---
        List({ space: 15 }) {
          ForEach(this.diaryList, (item: Diary) => {
            ListItem() {
              Column() {
                // ç¬¬ä¸€è¡Œï¼šæ—¶é—´å’ŒID
                Row() {
                  Text(item.created_at.split('T')[0])
                    .fontSize(12).fontColor('#999')
                  Text(`#${item.id}`)
                    .fontSize(12).fontColor('#ddd')
                }
                .width('100%')
                .justifyContent(FlexAlign.SpaceBetween)
                .margin({ bottom: 8 })

                // ç¬¬äºŒè¡Œï¼šæ—¥è®°å†…å®¹
                Text(item.content)
                  .fontSize(16)
                  .fontColor('#333')
                  .maxLines(2)
                  .textOverflow({ overflow: TextOverflow.Ellipsis })
                  .lineHeight(24)
                  .margin({ bottom: 10 })

                // ç¬¬ä¸‰è¡Œï¼šAI å›å¤ (å¦‚æœæœ‰)
                if (item.ai_comment) {
                  Row() {
                    // åŠ ä¸€ä¸ªå°å›¾æ ‡
                    Text('ğŸ¤–')
                      .margin({ right: 5 })
                    Text(item.ai_comment)
                      .fontSize(13)
                      .fontColor('#007DFF')
                      .maxLines(1)
                      .textOverflow({ overflow: TextOverflow.Ellipsis })
                      .layoutWeight(1) // å æ»¡å‰©ä½™ç©ºé—´
                  }
                  .width('100%')
                  .padding(12)
                  .backgroundColor('#F5F9FF') // æ›´æ¸…æ–°çš„è“è‰²èƒŒæ™¯
                  .borderRadius(8)
                }
              }
              .width('100%')
              .padding(18)
              .backgroundColor('#FFFFFF')
              .borderRadius(16) // æ›´åœ†æ¶¦çš„åœ†è§’
              // æ·»åŠ ä¸€ç‚¹é˜´å½±ï¼Œæ›´æœ‰è´¨æ„Ÿ
              .shadow({ radius: 8, color: 'rgba(0,0,0,0.05)', offsetY: 4 })
            }
            // âœ¨ ä¸ºæ¯ä¸ªåˆ—è¡¨é¡¹æ·»åŠ æ’å…¥åŠ¨ç”» âœ¨
            .transition({ type: TransitionType.Insert, opacity: 0, translate: { y: 20 } })
          }, (item: Diary) => item.id.toString()) // âš ï¸ åŠ ä¸Š Key ç”Ÿæˆå‡½æ•°ï¼Œæå‡æ€§èƒ½
        }
        .width('90%')
        .height('100%')
        .scrollBar(BarState.Off) // éšè—æ»šåŠ¨æ¡æ›´ç¾è§‚

        // --- å±‚çº§ 2: åŠ è½½æŒ‡ç¤ºå™¨ (LoadingProgress) ---
        // åªæœ‰ isLoading ä¸º true æ—¶æ‰æ˜¾ç¤ºï¼Œä¸”è¦†ç›–åœ¨åˆ—è¡¨ä¸Šé¢
        if (this.isLoading) {
          Column() {
            LoadingProgress()
              .color('#007DFF')
              .width(40)
              .height(40)
          }
          .width('100%')
          .height(100) // åªé®æŒ¡é¡¶éƒ¨ä¸€ç‚¹ç‚¹åŒºåŸŸï¼Œä¸å½±å“æ•´ä½“
          .justifyContent(FlexAlign.Center)
          // ç»™åŠ è½½åœˆæœ¬èº«ä¹ŸåŠ ä¸€ä¸ªæ·¡å…¥æ·¡å‡ºåŠ¨ç”»
          .transition({ type: TransitionType.All, opacity: 0 })
          .hitTestBehavior(HitTestMode.None) // è®©åŠ è½½åœˆä¸é˜»æŒ¡ä¸‹æ–¹åˆ—è¡¨çš„è§¦æ‘¸ï¼ˆå¯é€‰ï¼‰
        }

      }
      .layoutWeight(1) // å æ»¡å‰©ä½™çš„æ‰€æœ‰å‚ç›´ç©ºé—´
      .width('100%')

    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F7F8FA') // æ›´åŠ é«˜çº§çš„ç°ç™½è‰²èƒŒæ™¯
  }
}