import { apiService, StatsData } from '../services/ApiService';

@Component
export struct StatsView {
  @State statsData: StatsData | null = null;
  @State isLoading: boolean = false;
  // æ¥æ”¶ä¸»é¡µä¼ æ¥çš„åˆ·æ–°ä¿¡å·
  @Prop @Watch('onTriggerChange') refreshTrigger: number = 0;

  async aboutToAppear() {
    this.fetchData();
  }

  onTriggerChange() {
    this.fetchData();
  }

  async fetchData() {
    this.isLoading = true;
    this.statsData = await apiService.getStats();
    this.isLoading = false;
  }

  build() {
    Column() {
      Text('æƒ…ç»ªå‘¨æŠ¥')
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .margin({ top: 40, bottom: 20 })
        .width('90%')

      if (this.isLoading) {
        LoadingProgress().width(50).height(50).margin({ top: 100 })
      } else if (this.statsData && this.statsData.scores.length > 0) {

        // --- 1. AI æ€»ç»“å¡ç‰‡ ---
        Column() {
          Row() {
            Text('ğŸ§  AI æ·±åº¦åˆ†æ').fontWeight(FontWeight.Bold).fontColor('#007DFF')
          }
          .width('100%').margin({ bottom: 10 })

          Text(this.statsData.weekly_summary)
            .fontSize(15)
            .lineHeight(24)
            .fontColor('#333')
        }
        .width('90%')
        .backgroundColor('#fff')
        .padding(15)
        .borderRadius(12)
        .shadow({ radius: 10, color: 'rgba(0,0,0,0.05)' })
        .margin({ bottom: 30 })

        // --- 2. æ‰‹ç»˜æŠ˜çº¿å›¾åŒºåŸŸ ---
        Column() {
          Text('è¿‘7å¤©å¿ƒæƒ…èµ°åŠ¿').fontSize(16).fontWeight(FontWeight.Bold).margin({ bottom: 20 })

          // å›¾è¡¨å®¹å™¨
          Stack({ alignContent: Alignment.BottomStart }) {
            // èƒŒæ™¯æ¨ªçº¿ (1åˆ†åˆ°5åˆ†)
            Column() {
              ForEach([5, 4, 3, 2, 1], (score: number) => {
                Row() {
                  Text(score.toString()).fontSize(12).fontColor('#ccc').width(20)
                  Divider().vertical(false).strokeWidth(1).color('#f0f0f0').layoutWeight(1)
                }
                .width('100%')
                .height(40) // æ¯è¡Œé«˜åº¦
              })
            }

            // æ ¸å¿ƒï¼šæŠ˜çº¿ Polyline
            // âœ…ã€ä¿®å¤ç‚¹1ã€‘è¿™é‡Œä¸èƒ½åœ¨ {} é‡Œå†™ pointsï¼Œå¿…é¡»ç”¨ .points() é“¾å¼è°ƒç”¨
            Polyline()
              .width('100%')
              .height(200)
              .fillOpacity(0)
              .stroke(Color.Blue)
              .strokeWidth(3)
              .points(this.convertScoresToPoints(this.statsData.scores)) // points å¿…é¡»åœ¨è¿™é‡Œä¼ 
          }
          .width('90%')
          .height(220)

          // åº•éƒ¨æ—¥æœŸ
          Row() {
            ForEach(this.statsData.dates, (date: string) => {
              Text(date).fontSize(10).fontColor('#999').layoutWeight(1).textAlign(TextAlign.Center)
            })
          }
          .width('90%')
          .margin({ top: 5 })

        }
        .width('90%')
        .backgroundColor('#fff')
        .padding(15)
        .borderRadius(12)
        .shadow({ radius: 10, color: 'rgba(0,0,0,0.05)' })

      } else {
        // æ²¡æœ‰æ•°æ®æ—¶çš„ç©ºçŠ¶æ€
        Column() {
          Text('ğŸ“Š').fontSize(50)
          Text('å¤šå†™å‡ ç¯‡æ—¥è®°ï¼ŒAI æ‰èƒ½ä¸ºä½ ç”Ÿæˆå‘¨æŠ¥å“¦~')
            .fontSize(14).fontColor('#999').margin({ top: 10 })
        }
        .margin({ top: 100 })
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F7F8FA')
  }

  // --- è¾…åŠ©å‡½æ•° ---
  // âœ…ã€ä¿®å¤ç‚¹2ã€‘æ˜ç¡®è¿”å›å€¼ç±»å‹ä¸º Array<[number, number]>ï¼Œæ¶ˆé™¤ TS æŠ¥é”™
  convertScoresToPoints(scores: number[]): Array<[number, number]> {
    const points: Array<[number, number]> = [];
    const chartHeight = 200;
    const chartWidth = 300;
    const stepX = chartWidth / (scores.length - 1 || 1);

    scores.forEach((score, index) => {
      const x = index * stepX;
      // yè½´ç¿»è½¬è®¡ç®—
      const y = 200 - ((score) * 40) + 20;
      points.push([x, y]);
    });
    return points;
  }
}